<!DOCTYPE html>
<html>
  <meta charset="utf-8">
  <!-- <meta name="apple-mobile-web-app-capable" content="yes"> -->
  <!-- http://curran.github.io/screencasts/splittingCharts/examples/viewer/#/17 -->
  <!-- http://bl.ocks.org/mbostock/3885705 transitions-->
  <meta name="viewport" content="minimal-ui">
  <style>
    body {
      background-color: #0C0C1A;
      margin:           0px;
      padding:          0px;
      overflow:         hidden;
    }

    .axis line {
      fill:         none;
      stroke:       #ffffff;
      stroke-width: 1.6px;
    }
    .axis path {
      fill:            none;
      stroke:          #ffffff;
      stroke-width:    2.5px;
      shape-rendering: crispEdges;
    }
    .axis text {
      font: 12px sans-serif;
      shape-rendering: crispEdges;
      stroke-width:    1px;
      stroke: white;
      font-color: #fff;
    }
    .stations {
    }
    .station{
      fill:#0C0C1A;
    }
    .station:nth-child(even) {
      fill:#1A3047;
    }

    .delivery {
      stroke:          steelblue;
      stroke-width:    1px;
    }

    svg {
      background-color: #0C0C1A
    }
  </style>
  
  <body>
  </body>


  <script src="http://d3js.org/d3.v3.js"></script>
  <script>
    "use strict";
    
    //User Defined Variables
    var rowHeight   = 45;
    var xAxisHeight = 30;
    var xAxisWidth  = 3000;
    var margin      = {top: 0, right: 0, bottom: 30, left: 0};
    var outerWidth  = document.documentElement.clientWidth;
    var outerHeight = document.documentElement.clientHeight;
    var stations =  {
                      1:"En Route",
                      2:"Sierra One",
                      3:"Shed",
                      4:"Stinger Gate",
                      5:"Sally Port",
                      6:"Warehouse",
                      7:"Transit"
                    }

    //Calculated Variables
    var innerWidth     = outerWidth   - margin.left - margin.right;
    var innerHeight    = outerHeight  - margin.top  - margin.bottom;
    var unixHour       = 1000*60*60;
    var unixMinute     = 1000*60;
    var vpStartHours   = (outerWidth/2)/(xAxisWidth/24);  //startHours is the time where the Viewport's (middle of screen) y axis naturally rests.  Its time in hours.
    var unixStartHours = unixHour * vpStartHours; 
    var now            = new Date(Date.now());
    var nowHours       = now.getHours();
    var nowMinutes     = now.getMinutes();

    //Variables (to be used)
    var deliveries=[];
    var startingX;
    var duration, variation, variationMinutes;
    var yDeliveryScale;
    
    //scales
    var xScale = d3.time.scale.utc()
          .domain([+new Date(2000, 0, 1),                 +new Date(2000, 0, 1,24)])
          .range( [0,                                     xAxisWidth]);

    var yDeliveryScale = d3.scale.linear()
          .domain([1,7])
          .range([1+rowHeight,7*rowHeight]);

    var viewportScale = d3.time.scale.utc()
          .domain([+new Date(2000, 0, 1)+unixStartHours,  +new Date(2000, 0, 1,24)-unixStartHours])
          .range( [0,                                     -1*xAxisWidth+outerWidth]);


    startingX = viewportScale(new Date(2000,0,1,nowHours,nowMinutes));

    //Create Data
    for(var i = 17; i > 0; i--){
      duration  = 4;
      variation = Math.random() * 1;
      variationMinutes = Math.random()*60;

      deliveries.push({  startTime: new Date(2000, 0, 1,12+(i*.2)+variation,variationMinutes), 
                         endTime:   new Date(2000, 0, 1,12+(i*.2)+variation + duration,variationMinutes),
                         station:Math.round(i/2.5)
                       });
    }

    //Structure
    var svg = d3.select("body").append("svg")
          .attr("width",  outerWidth)
          .attr("height", outerHeight);

    var stationsG = svg.append("g")
          .attr("class", "stations")
          .attr('transform', 'translate(' + 0 + "," + 0 + ')');

    var g = svg.append("g")
          .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

    var deliveriesG = g.append("g")
          .attr("class", "deliveries")
          .attr('transform', 'translate(' + startingX + "," + 0 + ')');

    var xAxisG = g.append("g")
          .attr("class", "x axis")
          .attr('transform', 'translate(' + startingX + "," +  innerHeight + ')');

    var yAxisG = g.append("g")
          .attr("class", "y axis");
        

    //Helper Fucntions
    var xAxis = d3.svg.axis()
          .ticks(d3.time.hours, 1)
          .tickFormat(d3.time.format('%H'))
          .scale(xScale);

    function render(data){

      //data manipulation
      var stationCounts =[0,0,0,0,0,0,0,0];
      var stationStackedCount=[0,0,0,0,0,0,0,0]
      var stationStacked=[];
      for(var i =0;i<data.length;i++){
        console.log(data[i].station);
        stationCounts[data[i].station]++;
      }

      for (var i = 0; i < stationCounts.length; i++) { //make sure they have at least 1
        stationCounts[i] = stationCounts[i] || 1;
      };

      stationStackedCount[0] = stationCounts[0];
      for (var i = 1; i < stationCounts.length; i++) {
        stationStackedCount[i] = stationStackedCount[i-1]+ stationCounts[i];
      };
      var stationStacked = [];
      stationStacked[0]={"y0":0,"y":stationCounts[0]}
      for (var i = 1; i < stationStackedCount.length; i++) {
        stationStacked[i] = {
                              "y0":stationStackedCount[i-1],
                              "y":stationCounts[i]
                            };
      };

      var stationsS = stationsG.selectAll(".station").data(stationStacked);
      stationsS.enter().append("rect"); // stations should never exit

      stationsS
          .attr("x", function(d,i) { return 0;})
          .attr("y", function(d,i) { return d.y0*rowHeight+ (rowHeight/2);})
          .attr("width",innerWidth)
          .attr("height", function(d,i) { return d.y*rowHeight;})
          .attr("class", "station");


      //setup axii
      xAxisG.call(xAxis);
      yAxisG.append("line")
          .style("stroke-dasharray", ("2, 2"))
          .attr("x1", innerWidth/2)
          .attr("y1", margin.top)
          .attr("x2", outerWidth/2)
          .attr("y2", innerHeight);

      // Bind data
      var deliveriesS = deliveriesG.selectAll(".delivery").data(data);

      // Enter
      deliveriesS.enter().append("line");

      // Exit
      deliveriesS.exit().remove();

      // Update
      deliveriesS
          .attr("x1", function(d,i) { return xScale(d.startTime); })
          .attr("y1", function(d,i) { return yDeliveryScale(i+1); })
          .attr("x2", function(d,i) { return xScale(d.endTime); })
          .attr("y2", function(d,i) { return yDeliveryScale(i+1); })
          .attr("class", "delivery");

    }

    render(deliveries);

  </script>
</html>

